{
  "AWSTemplateFormatVersion" : "2010-09-09",
  "Description" : "Default Buckets Data, Scripts and Users",
  "Parameters" : {
    "AccountName" : {
      "Description"   : "Account Name",
      "Type"          : "String"
    },
    "CustomerName" : {
      "Description"   : "Customer Name",
      "Type"          : "String"
    },
    "ProjectName" : {
      "Description"   : "Project Name",
      "Type"          : "String"
    }
  },
  
  "Resources" : {
    "DataBucket" : {
      "Type" : "AWS::S3::Bucket",
      "Properties" : {
        "AccessControl" : "Private",
        "BucketName" : { "Fn::Join" : ["-", [ { "Ref" : "ProjectName" }, "data" ] ] },
        "LoggingConfiguration" : {
          "DestinationBucketName": { "Fn::ImportValue" : { "Fn::Join" : ["-", [ { "Ref" : "AccountName" },"LogsBucket" ] ] } },
          "LogFilePrefix": { "Fn::Join" : [ "", [ "S3/", { "Ref" : "ProjectName" }, "-data/" ] ] } 
        },
        "Tags" : [ 
          { "Key" : "Customer",    "Value" : { "Ref" : "CustomerName" } },
          { "Key" : "Project",     "Value" : { "Ref" : "ProjectName" } }
        ]
      }
    },
    "DataBucketPolicy" : {
      "Type" : "AWS::S3::BucketPolicy",
      "Properties" : {
        "Bucket" : {"Ref" : "DataBucket"},
        "PolicyDocument" : {
          "Statement" :[
            {
              "Sid": "DenyBucketACL",
              "Effect": "Deny",
              "Principal": "*",
              "Action": [
                  "s3:PutBucketAcl",
                  "s3:PutBucketCORS"
              ],
              "Resource": { "Fn::GetAtt" : [ "DataBucket", "Arn" ] }
            },
            {
              "Sid": "DenyObjectACL",
              "Effect": "Deny",
              "Principal": "*",
              "Action": [
                  "s3:PutObjectAcl",
                  "s3:PutObjectVersionAcl"
              ],
              "Resource": { "Fn::Join" : ["", [ { "Fn::GetAtt" : [ "DataBucket", "Arn" ] }, "/*" ] ] }
            }
          ]
        }
      }
    },
    
    "ScriptsBucket" : {
      "Type" : "AWS::S3::Bucket",
      "Properties" : {
        "AccessControl" : "Private",
        "BucketName" : { "Fn::Join" : ["-", [ { "Ref" : "ProjectName" }, "scripts" 
          ] ] 
        }, 
        "LoggingConfiguration" : {
          "DestinationBucketName": { "Fn::ImportValue" : { "Fn::Join" : ["-", [ { "Ref" : "AccountName" },"LogsBucket" ] ] } },
          "LogFilePrefix": { "Fn::Join" : [ "", [ "S3/", { "Ref" : "ProjectName" }, "-scripts/" ] ] } 
        },
        "Tags" : [ 
          { "Key" : "Customer",    "Value" : { "Ref" : "CustomerName" } },
          { "Key" : "Project",     "Value" : { "Ref" : "ProjectName" } }
        ]
      }
    },
    "ScriptsBucketPolicy" : {
      "Type" : "AWS::S3::BucketPolicy",
      "Properties" : {
        "Bucket" : {"Ref" : "ScriptsBucket"},
        "PolicyDocument" : {
          "Statement" :[
            {
              "Sid": "DenyBucketACL",
              "Effect": "Deny",
              "Principal": "*",
              "Action": [
                  "s3:PutBucketAcl",
                  "s3:PutBucketCORS"
              ],
              "Resource": { "Fn::GetAtt" : [ "ScriptsBucket", "Arn" ] }
            },
            {
              "Sid": "DenyObjectACL",
              "Effect": "Deny",
              "Principal": "*",
              "Action": [
                  "s3:PutObjectAcl",
                  "s3:PutObjectVersionAcl"
              ],
              "Resource": { "Fn::Join" : ["", [ { "Fn::GetAtt" : [ "ScriptsBucket", "Arn" ] }, "/*" ] ] }
            }
          ]
        }
      }
    },
    
    "UsersBucket" : {
      "Type" : "AWS::S3::Bucket",
      "Properties" : {
        "AccessControl" : "Private",
        "BucketName" : { "Fn::Join" : ["-", [ { "Ref" : "ProjectName" }, "users" 
          ] ] 
        }, 
        "LoggingConfiguration" : {
          "DestinationBucketName": { "Fn::ImportValue" : { "Fn::Join" : ["-", [ { "Ref" : "AccountName" },"LogsBucket" ] ] } },
          "LogFilePrefix": { "Fn::Join" : [ "", [ "S3/", { "Ref" : "ProjectName" }, "-users/" ] ] } 
        },
        "Tags" : [ 
          { "Key" : "Customer",    "Value" : { "Ref" : "CustomerName" } },
          { "Key" : "Project",     "Value" : { "Ref" : "ProjectName" } }
        ]
      }
    },
    "UsersBucketPolicy" : {
      "Type" : "AWS::S3::BucketPolicy",
      "Properties" : {
        "Bucket" : {"Ref" : "UsersBucket"},
        "PolicyDocument" : {
          "Statement" :[
            {
              "Sid": "DenyBucketACL",
              "Effect": "Deny",
              "Principal": "*",
              "Action": [
                  "s3:PutBucketAcl",
                  "s3:PutBucketCORS"
              ],
              "Resource": { "Fn::GetAtt" : [ "UsersBucket", "Arn" ] }
            },
            {
              "Sid": "DenyObjectACL",
              "Effect": "Deny",
              "Principal": "*",
              "Action": [
                  "s3:PutObjectAcl",
                  "s3:PutObjectVersionAcl"
              ],
              "Resource": { "Fn::Join" : ["", [ { "Fn::GetAtt" : [ "UsersBucket", "Arn" ] }, "/*" ] ] }
            }
          ]
        }
      }
    }
  },
  "Outputs" : {
    "DataBucket" : {
      "Description" : "Data Bucket Name",
      "Value" : { "Ref" : "DataBucket" },
      "Export" : {
        "Name" : { "Fn::Join" : [ "-", [ { "Ref" : "ProjectName" }, "DataBucket" ] ] }
      }
    },
    "DataBucketArn" : {
      "Description" : "Data Bucket Arn",
      "Value" : { "Fn::GetAtt" : [ "DataBucket", "Arn" ] },
      "Export" : {
        "Name" : { "Fn::Join" : [ "-", [ { "Ref" : "ProjectName" }, "DataBucketArn" ] ] }
      }
    },
    "ScriptsBucket" : {
      "Description" : "Scripts Bucket Name",
      "Value" : { "Ref" : "DataBucket" },
      "Export" : {
        "Name" : { "Fn::Join" : [ "-", [ { "Ref" : "ProjectName" }, "ScriptsBucket" ] ] }
      }
    },
    "ScriptsBucketArn" : {
      "Description" : "Scripts Bucket Arn",
      "Value" : { "Fn::GetAtt" : [ "ScriptsBucket", "Arn" ] },
      "Export" : {
        "Name" : { "Fn::Join" : [ "-", [ { "Ref" : "ProjectName" }, "ScriptsBucketArn" ] ] }
      }
    },
    "UsersBucket" : {
      "Description" : "Users Bucket Name",
      "Value" : { "Ref" : "DataBucket" },
      "Export" : {
        "Name" : { "Fn::Join" : [ "-", [ { "Ref" : "ProjectName" }, "UsersBucket" ] ] }
      }
    },
    "UsersBucketArn" : {
      "Description" : "Users Bucket Arn",
      "Value" : { "Fn::GetAtt" : [ "UsersBucket", "Arn" ] },
      "Export" : {
        "Name" : { "Fn::Join" : [ "-", [ { "Ref" : "ProjectName" }, "UsersBucketArn" ] ] }
      }
    }
  }
}